# Frontend interfaces

### token的唯一标识：
flow上，每个token都是由 address + tokenName 作为key唯一标识的：
> 比如: A.f8d6e0586b0a20c7.FlowToken

### token list，官方维护，Flow放第一个，其他按照字母排序
~~默认显示主流的list: `tokenlist.popular.mainnet.json`~~

官方记录的全部list: `tokenlist.all.mainnet.json`

举例:
```json
{
    "A.1654653399040a61.FlowToken": {
        "tokenName": "FlowToken",
        "tokenAddress": "0x1654653399040a61",
        "showName": "Flow",
        "vaultPath": "flowTokenVault",
        "vaultBalancePath": "flowTokenBalance",
        "vaultReceiverPath": "flowTokenReceiver",
        "icon": "https://s2.coinmarketcap.com/static/img/coins/64x64/4558.png",
        "info": "Flow Officer"
    }
}
```

### 获取1个或者n个token的本地钱包余额：
script接口: `QueryTokenLocalBalances.cdc`
参数: 1. userAddr 2. [balancePath数组]
返回: [余额数组]
balancePath举例: 
```js
    {
        "domain": "public",
        "identifier": "flowTokenBalance"
    };
```
关于balancePath:
1. 如果是知名的token，从token list config里获取该路径: "flowTokenBalance"
2. 如果是用户添加的小众币种，`tokenlist.all.mainnet.json`里没有，需要根据tokenName预测出一个结果，同时让添加者确认并可修改

   
### 地址搜索框
##### 用户输入搜索地址： 0xf8d6e0586b0a20c7
1. 调用script接口 `QueryTokenNames()` 获取部署在该地址下继承fungibleToken的合约名
   参数: 1. contractAddr 2. ""空字符串，表示搜索全部合约名
   返回: [tokenName数组] 该地址下的token name数组
2. 如果只有一个token直接下一步，否则需要用户选择List
3. 如果该 A.addr.TokenName不在常见列表`tokenlist.all.mainnet.json`中，还需要弹出确认窗口
X. 确认框中有三个path的输入框确认，用户可以修改： VaultPath, BalancePath, ReceiverPath
        默认值是:
        * 如果TokenName全部是大写字母，则prefix是全小写， FUSD -> fusdVault, fusdBalance, fusdReceiver
        * 如果TokenName含大小写字母，则prefix是首字母小写， FlowToken -> flowTokenVault, flowTokenBalance, flowTokenReceiver



##### 不做 XXX 用户搜索完整地址+名字： A.f8d6e0586b0a20c7.FlowToken
- 如果在`tokenlist.all.mainnet.json`中，直接显示
- 否则调用script接口 `SearchTokens.cdc`
  参数: 1. contractAddr 2. tokenName
  返回: []空则表示无效的token


### 当用户选择tokenIn tokenOut之后，需要记录下：
`tokenInAddr  = 0x1654653399040a61`  `tokenInName  = FlowToken` `tokenInKey  = A.1654653399040a61.FlowToken`
`tokenOutAddr = 0x3654653399040a61`  `tokenOutName = FUSD`      `tokenOutKey = A.3654653399040a61.FUSD`


### 获取token0 token1之间的graph nodes
js接口: `GetInnerPairAddrs()`
参数: 1. tokenInKey 2. tokenOutKey
返回: [0xPairAddr1, 0xPairAddr2, 0xPairAddr3]
* 如果页面停留，每隔1分钟重新调用


### 获取pair深度（定时调用更新）
script接口: `QueryPairInfos.cdc`
参数: [0xPairAddr1, 0xPairAddr2, 0xPairAddr3]
返回:
```json
{
    "0xPairAdd1": {
        "A.1654653399040a61.FlowToken": 80,
        "A.1654653399040a61.FUSD": 200,
    },
    ...
}
```
* 并将返回结果作为输入，调用js接口: `UpdatePairInfos()`


### 获得swap routes
js接口：`Pathfinding()`
参数: 1. tokenInKey 2. tokenInAmount 3. tokenOutKey 4. tokenOutAmount
其中 tokenInAmount 与 tokenOutAmount 只有一个大于0
返回: json
返回举例：
```json
{
    "tokenInKey": "A.1654653399040a61.FlowToken",
    "tokenOutKey": "A.1654653399040a61.FUSD",
    "tokenInAmount": 10,
    "tokenOutAmount": 20,
    "priceImpact": "0.1",
    "routes": [
        {
            "routeAmountIn": 2,
            "routeAmountOut": 4,
            "route": [tokenInKey, tokenKey_a, tokenOutKey]
        },
        {
            "routeAmountIn": 8,
            "routeAmountOut": 16,
            "route": [tokenInKey, tokenKey_b, tokenKey_c, tokenOutKey]
        },
        ...
    ]
}
```
* 每当重新获取深度数据，或者用户修改了输入金额，需要重新调用`Pathfinding()`
* 如果输入的是 tokenInAmount, 则 tokenOutAmount就是输出的结果
* 如果输入的是 tokenOutAmount, 则 tokenInAmount就是输出的结果


### Swap
#### 根据tokenIn的输入量 兑换 tokenOut
transaction接口: `SwapExactTokensForTokens.cdc`
> 注意该tx接口是模板文件，js里需要做字符串规则替换，具体会提供替换规则接口
规则替换有关参数: 
1. tokenInKey
2. tokenOutKey
3. tokenInAmount
4. amountOutMin 根据`Pathfinding()`结果预估与滑点设置计算的最小值
5. 最长执行时间
6. [routes] 从Pathfinding()返回结果中取
返回: 无
#### 根据tokenOut的输入量 计算需要的tokenIn，再兑换tokenOut
transaction接口: `swapTokensForExtractTokens.cdc`
参数: tokenOutAmount 其余同上



根据用户输入 token0Key 与 token1Key 
### 查询当前池子地址
script接口: `QueryPairAddr.cdc`
参数: 1. token0Key 2. token1Key
返回: addr
script接口: `QueryPairInfos.cdc` 用法见前文
* 如果有深度数据则： AddLiquidity
* 如果池子不存在：CreatePair

### AddLiquidity
###### 根据深度比例 和 用户输入，在前端可以计算出各需要多少token
###### 添加流动性
transaction接口: `AddLiquidity()`
> 注意该tx接口是模板文件，js里需要做字符串规则替换，具体会提供替换规则接口
参数:  待定

### CreatePair
transaction接口: `CreatePair()`
参数: 待定


### 获取已添加的流动性列表
待定